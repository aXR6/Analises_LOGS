{% extends 'base.html' %}
{% block content %}
<h2 class="mb-4">Eventos Recentes</h2>
<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-3">
  <form id="filter-form" class="d-flex flex-wrap gap-2" method="get">
    <select name="severity" class="form-select form-select-sm">
      <option value="">Todas</option>
      <option value="INFO">INFO</option>
      <option value="WARNING">WARNING</option>
      <option value="ERROR">ERROR</option>
    </select>
    <button class="btn btn-sm btn-primary" type="submit">Filtrar</button>
  </form>
  <div class="d-flex gap-2">
    <a href="?page={{ page-1 if page>1 else 1 }}{% if severity %}&severity={{ severity }}{% endif %}" class="btn btn-sm btn-secondary">Anterior</a>
    <a href="?page={{ page+1 }}{% if severity %}&severity={{ severity }}{% endif %}" class="btn btn-sm btn-secondary">Pr칩ximo</a>
  </div>
</div>
<div id="log-list" class="list-group">
{% for row in logs %}
  <div class="list-group-item small d-flex flex-column flex-lg-row justify-content-between gap-2 {% if row[8] or row[9] %}list-group-item-danger{% endif %}">
    <div class="flex-grow-1">
      <div class="d-flex flex-wrap gap-2">
        <span><strong>ID:</strong> {{row[0]}}</span>
        <span><strong>{{row[1]}}</strong></span>
        <span><strong>Host:</strong> {{row[2]}}</span>
        <span><strong>Programa:</strong> <a href="?program={{row[3]}}">{{row[3]}}</a></span>
      </div>
      <div class="d-flex flex-wrap gap-2">
        <span class="{{ severity_colors.get(row[6], '') }}"><strong>{{row[6]}}{{ '*' if row[8] else '' }}</strong></span>
        <span><strong>Anomalia:</strong> {{ '%.2f' | format(row[7]|float) }}</span>
        <span><strong>Sem칙ntica:</strong> {{ 'sim' if row[9] else 'nao'}}</span>
        {% if row[10] %}<span class="badge text-bg-danger">{{ row[10] }}</span>{% endif %}
      </div>
      <div class="text-break">{{row[4]}}</div>
    </div>
    <div class="mt-2 mt-lg-0">
      <button class="btn btn-sm btn-outline-primary" onclick="analyzeLog({{row[0]}})">Analisar</button>
    </div>
  </div>
{% endfor %}
</div>
<!-- Modal -->
<div class="modal fade" id="analysisModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Resultado da An치lise</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="analysis-content"></div>
    </div>
</div>
</div>
</div>
<script>
const severityColors = {{ severity_colors | tojson }};
async function fetchLogs(page = {{ page }}) {
  const params = new URLSearchParams({page: page, severity: '{{ severity or '' }}', program: '{{ program or '' }}'});
  const resp = await fetch('/api/logs?' + params.toString());
  if (!resp.ok) return;
  const data = await resp.json();
  const list = document.getElementById('log-list');
  list.innerHTML = '';
  for (const row of data.logs) {
    const item = document.createElement('div');
    item.className = 'list-group-item small d-flex flex-column flex-lg-row justify-content-between gap-2';
    if (row[8] || row[9]) item.classList.add('list-group-item-danger');
    item.innerHTML = `
        <div class="flex-grow-1">
          <div class="d-flex flex-wrap gap-2">
            <span><strong>ID:</strong> ${row[0]}</span>
            <span><strong>${row[1]}</strong></span>
            <span><strong>Host:</strong> ${row[2]}</span>
            <span><strong>Programa:</strong> <a href="?program=${row[3]}">${row[3]}</a></span>
          </div>
          <div class="d-flex flex-wrap gap-2">
            <span class="${severityColors[row[6]] || ''}"><strong>${row[6]}${row[8] ? '*' : ''}</strong></span>
            <span><strong>Anomalia:</strong> ${row[7].toFixed(2)}</span>
            <span><strong>Sem칙ntica:</strong> ${row[9] ? 'sim' : 'nao'}</span>
            ${row[10] ? `<span class="badge text-bg-danger">${row[10]}</span>` : ''}
          </div>
          <div class="text-break">${row[4]}</div>
        </div>
        <div class="mt-2 mt-lg-0">
          <button class="btn btn-sm btn-outline-primary" onclick="analyzeLog(${row[0]})">Analisar</button>
        </div>`;
    list.appendChild(item);
  }
}
async function analyzeLog(id) {
  const resp = await fetch('/api/analyze/' + id);
  if (!resp.ok) { alert('erro ao analisar'); return; }
  const data = await resp.json();
  const modalBody = document.getElementById('analysis-content');
  modalBody.textContent = data.result;
  const modal = new bootstrap.Modal(document.getElementById('analysisModal'));
  modal.show();
}
fetchLogs();
setInterval(fetchLogs, 5000);
</script>
{% endblock %}
