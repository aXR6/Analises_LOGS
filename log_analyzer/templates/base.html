<!doctype html>
<html data-bs-theme="dark">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Log Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-dark text-light">
<nav id="navbar" class="navbar mb-4">
  <div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center">
      <span class="navbar-brand mb-0 h1">Log Dashboard</span>
      <ul class="navbar-nav flex-row gap-3">
        <li class="nav-item position-relative">
          <a href="{{ url_for('logs_page') }}" class="nav-link {% if menu=='logs' %}active{% endif %}">Logs</a>
          <span id="badge-logs" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">+1</span>
        </li>
        <li class="nav-item position-relative">
          <a href="{{ url_for('analyzed_page') }}" class="nav-link {% if menu=='analyzed' %}active{% endif %}">Analisados</a>
          <span id="badge-analyzed" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">+1</span>
        </li>
        <li class="nav-item position-relative">
          <a href="{{ url_for('network_page') }}" class="nav-link {% if menu=='network' %}active{% endif %}">Trafego de rede</a>
          <span id="badge-network" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">+1</span>
        </li>
      </ul>
    </div>
    <div id="toolbar" class="d-flex flex-wrap gap-3 small mt-2 p-2 rounded bg-secondary text-light">
      <span id="severity-info"></span>
      <span id="attack-info"></span>
      <span id="alert-info" class="text-danger"></span>
      <span id="iface-info"></span>
      <button id="theme-toggle" class="btn btn-sm btn-secondary" type="button">
        <i id="theme-icon" class="bi"></i>
      </button>
    </div>
  </div>
</nav>
<div class="container my-4">
{% block content %}{% endblock %}
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const SEVERITY_COLORS = {{ severity_colors | tojson }};
async function fetchStats() {
  const resp = await fetch('/api/stats');
  if (!resp.ok) return;
  const data = await resp.json();
  const sev = document.getElementById('severity-info');
  const attacks = document.getElementById('attack-info');
  const iface = document.getElementById('iface-info');
  sev.innerHTML = Object.entries(data.severity).map(
    ([k,v]) => `<span class="${SEVERITY_COLORS[k] || ''} me-2">${k}: ${v}</span>`
  ).join(' ');
  attacks.textContent = Object.entries(data.attacks).map(
    ([k,v]) => `${k}: ${v}`
  ).join(' ');
  iface.textContent = `Ativas: ${data.interfaces.active.join(', ')} | Atividade: ${data.interfaces.activity.join(', ')}`;
}

async function fetchAlerts() {
  const resp = await fetch('/api/alerts');
  if (!resp.ok) return;
  const data = await resp.json();
  const bar = document.getElementById('alert-info');
  if (!data.alerts.length) {
    bar.textContent = '';
    return;
  }
  const last = data.alerts[0];
  const src = last.src || 'desconhecido';
  const dst = last.dst || 'desconhecido';
  bar.textContent = `${last.attack || 'ataque'}: ${src} -> ${dst}`;
}
fetchStats();
fetchAlerts();
setInterval(fetchStats, 5000);
setInterval(fetchAlerts, 5000);
const COUNT_KEY = 'counts';
const currentMenu = '{{ menu }}';
let lastCounts = JSON.parse(localStorage.getItem(COUNT_KEY) || '{}');
let countsReady = Object.keys(lastCounts).length > 0;

async function fetchCounts() {
  const resp = await fetch('/api/counts');
  if (!resp.ok) return;
  const data = await resp.json();
  if (!countsReady) {
    lastCounts = data;
    countsReady = true;
    localStorage.setItem(COUNT_KEY, JSON.stringify(lastCounts));
    return;
  }
  for (const key of ['logs','analyzed','network']) {
    const diff = data[key] - (lastCounts[key] || 0);
    const badge = document.getElementById('badge-' + key);
    if (diff > 0 && currentMenu !== key) {
      badge.textContent = '+' + diff;
      badge.classList.remove('d-none');
    } else if (currentMenu === key) {
      lastCounts[key] = data[key];
      badge.classList.add('d-none');
    }
  }
  localStorage.setItem(COUNT_KEY, JSON.stringify(lastCounts));
}

fetchCounts();
setInterval(fetchCounts, 5000);
const THEME_KEY = 'theme';
function applyTheme(theme) {
  document.documentElement.setAttribute('data-bs-theme', theme);
  const nav = document.getElementById('navbar');
  const body = document.body;
  const icon = document.getElementById('theme-icon');
  if (theme === 'dark') {
    nav.classList.add('navbar-dark','bg-dark');
    nav.classList.remove('navbar-light','bg-light');
    body.classList.add('bg-dark','text-light');
    body.classList.remove('bg-light','text-dark');
    icon.className = 'bi bi-moon-fill';
  } else {
    nav.classList.add('navbar-light','bg-light');
    nav.classList.remove('navbar-dark','bg-dark');
    body.classList.add('bg-light','text-dark');
    body.classList.remove('bg-dark','text-light');
    icon.className = 'bi bi-sun-fill';
  }
}
const savedTheme = localStorage.getItem(THEME_KEY) || 'dark';
applyTheme(savedTheme);
document.getElementById('theme-toggle').addEventListener('click', () => {
  const current = document.documentElement.getAttribute('data-bs-theme');
  const next = current === 'dark' ? 'light' : 'dark';
  localStorage.setItem(THEME_KEY, next);
  applyTheme(next);
});
</script>
</body>
</html>
