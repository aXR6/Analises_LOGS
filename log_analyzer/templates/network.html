{% extends 'base.html' %}
{% block content %}
<h2 class="mb-4">Tráfego de Rede</h2>
<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-3">
  <form class="d-flex flex-wrap gap-2" method="get">
    <select name="source" class="form-select form-select-sm">
      <option value="">Todos</option>
      {% for s in sources %}
      <option value="{{s}}" {% if s==source %}selected{% endif %}>{{s}}</option>
      {% endfor %}
    </select>
    <button class="btn btn-sm btn-primary" type="submit">Filtrar</button>
  </form>
  <div class="d-flex gap-2">
    <a href="?page={{ page-1 if page>1 else 1 }}{% if source %}&source={{ source }}{% endif %}" class="btn btn-sm btn-secondary">Anterior</a>
    <a href="?page={{ page+1 }}{% if source %}&source={{ source }}{% endif %}" class="btn btn-sm btn-secondary">Próximo</a>
  </div>
</div>
<div id="net-list" class="list-group"></div>
<!-- Modal reuse -->
<div class="modal fade" id="analysisModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Resultado da Análise</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="analysis-content"></div>
    </div>
  </div>
</div>
<script>
const NET_LABEL_COLORS = {{ label_colors | tojson }};
const startPage = {{ page }};
const currentSource = "{{ source or '' }}";
function labelClass(name) {
  const key = name.toLowerCase();
  return NET_LABEL_COLORS[key] || '';
}
async function fetchNetwork(page=startPage) {
  const params = new URLSearchParams({page: page, source: currentSource});
  const resp = await fetch('/api/network?' + params.toString());
  if (!resp.ok) return;
  const data = await resp.json();
  const list = document.getElementById('net-list');
  list.innerHTML = '';
  for (const row of data.events) {
    const item = document.createElement('div');
    item.className = 'list-group-item small d-flex flex-column flex-lg-row justify-content-between gap-2';
    if (row[3].toLowerCase() !== 'normal') {
      // Use a warning background for suspicious events to avoid very strong
      // colors when many entries are present
      item.classList.add('list-group-item-warning');
    }
    item.innerHTML = `
        <div class="flex-grow-1">
          <div class="d-flex flex-wrap gap-2">
            <span><strong>ID:</strong> ${row[0]}</span>
            <span><strong>${row[1]}</strong></span>
            <span><strong>Modulo:</strong> <a href="?source=${row[5]}">${row[5] || 'desconhecido'}</a></span>
          </div>
          <div class="d-flex flex-wrap gap-2">
            <span class="${labelClass(row[3])}">${row[3]}</span>
            <span><strong>Score:</strong> ${row[4].toFixed(2)}</span>
          </div>
          <div class="text-break">${row[2]}</div>
        </div>
        <div class="mt-2 mt-lg-0">
          <button class="btn btn-sm btn-outline-primary" onclick="analyzeNet(${row[0]})">Analisar</button>
        </div>`;
    list.appendChild(item);
  }
}

async function analyzeNet(id) {
  const resp = await fetch('/api/analyze_network/' + id);
  if (!resp.ok) { alert('erro ao analisar'); return; }
  const data = await resp.json();
  const modalBody = document.getElementById('analysis-content');
  modalBody.textContent = data.result;
  const modal = new bootstrap.Modal(document.getElementById('analysisModal'));
  modal.show();
}
fetchNetwork();
setInterval(fetchNetwork, 5000);
</script>
{% endblock %}
